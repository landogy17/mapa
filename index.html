<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Svƒõteln√© zneƒçi≈°tƒõn√≠ ƒåR</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: white;
        }

        h1 {
            text-align: center;
            padding: 12px;
            font-size: 1.2em;
            background: #0f0f23;
            letter-spacing: 1px;
        }

        #controls {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 8px 20px;
            background: #0f0f23;
            font-size: 0.9em;
            flex-wrap: wrap;
        }

        #controls label {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #opacity-slider { width: 150px; cursor: pointer; }

        #opacity-value {
            min-width: 35px;
            font-weight: bold;
            color: #ffd700;
        }

        /* ===== VYHLED√ÅV√ÅN√ç ===== */
        #search-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
        }

        #search-input {
            width: 260px;
            padding: 7px 14px;
            border-radius: 20px;
            border: 2px solid #444;
            background: #1a1a2e;
            color: white;
            font-size: 0.95em;
            outline: none;
            transition: border-color 0.2s;
        }

        #search-input:focus { border-color: #ffd700; }
        #search-input::placeholder { color: #888; }

        #search-btn {
            padding: 7px 14px;
            border-radius: 20px;
            border: none;
            background: #ffd700;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
        }

        #search-btn:hover { background: #ffec6e; }
        #search-btn:disabled { background: #888; cursor: not-allowed; }

        #search-results {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            width: 340px;
            background: #1e1e3a;
            border: 1px solid #555;
            border-radius: 8px;
            max-height: 320px;
            overflow-y: auto;
            z-index: 9999;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            display: none;
        }

        #search-results.visible { display: block; }

        .search-result-item {
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            font-size: 0.88em;
            transition: background 0.15s;
        }

        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: #2a2a5a; }

        .search-result-item .name {
            font-weight: bold;
            color: #ffd700;
        }

        .search-result-item .detail {
            color: #aaa;
            font-size: 0.85em;
            margin-top: 2px;
        }

        /* ≈ò√°dek s barvou zneƒçi≈°tƒõn√≠ v dropdownu */
        .search-result-item .pollution-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 4px;
            font-size: 0.82em;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
        }

        .badge-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.4);
            flex-shrink: 0;
        }

        /* ===== POPUP NA MAPƒö ===== */
        .popup-pollution-box {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
            padding: 6px 10px;
            border-radius: 6px;
            background: #f5f5f5;
            border: 2px solid #ddd;
        }

        .popup-pollution-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid rgba(0,0,0,0.3);
            flex-shrink: 0;
        }

        .popup-pollution-text {
            font-size: 0.85em;
            line-height: 1.4;
        }

        .popup-pollution-text strong {
            display: block;
            font-size: 1em;
            color: #222;
        }

        .popup-pollution-text span {
            color: #555;
            font-size: 0.9em;
        }

        /* ===== MAPA ===== */
        #map { width: 100%; height: calc(100vh - 100px); }

        /* ===== LEGENDA ===== */
        .legend {
            background: rgba(0,0,0,0.88);
            padding: 15px 21px;
            border-radius: 8px;
            font-size: 1.17em;
            line-height: 2.1;
            border: 1px solid #555;
            max-width: 260px;
        }

        .legend h4 {
            margin-bottom: 8px;
            font-size: 1.05em;
            color: #ffd700;
            border-bottom: 1px solid #555;
            padding-bottom: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 9px;
            margin: 3px 0;
        }

        .legend-color {
            width: 27px;
            height: 21px;
            border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.3);
            flex-shrink: 0;
        }
    </style>
</head>
<body>

<h1>üåô UMƒöL√ù JAS NOƒåN√ç OBLOHY NAD ƒåESKOU REPUBLIKOU</h1>

<div id="controls">
    <label>
        Pr≈Øhlednost overlay:
        <input type="range" id="opacity-slider" min="10" max="100" value="70" />
        <span id="opacity-value">70%</span>
    </label>

    <span style="color:#aaa; font-size:0.85em;">
        üí° Koleƒçko my≈°i = zoom &nbsp;|&nbsp; T√°hni = posun
    </span>

    <div id="search-container">
        <input
            type="text"
            id="search-input"
            placeholder="üîç Hledat obec nebo mƒõsto..."
            autocomplete="off"
        />
        <button id="search-btn">Naj√≠t</button>
        <div id="search-results"></div>
    </div>
</div>

<div id="map"></div>

<!-- Skryt√Ω canvas pro ƒçten√≠ pixel≈Ø z PNG -->
<canvas id="pixel-canvas" style="display:none"></canvas>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ================================================================
// NASTAVEN√ç
// ================================================================
const IMAGE_URL    = 'mapa_svetelne_znecisteni.png';
const IMAGE_BOUNDS = [
    [51.08, 12.05],   // lev√Ω horn√≠ roh (SZ)
    [48.55, 18.87]    // prav√Ω doln√≠ roh (JV)
];
const CZ_CENTER    = [49.82, 15.47];
const INITIAL_ZOOM = 7;

// ================================================================
// PALETA BAREV ‚Äî ka≈æd√° kategorie m√° RGB st≈ôed + toleranci
// Hodnoty odpov√≠daj√≠ barv√°m v tv√©m PNG obr√°zku.
// Pokud detekce nesed√≠, uprav RGB dle skuteƒçn√Ωch pixel≈Ø.
// ================================================================
const COLOR_CATEGORIES = [
    {
        label:  '< 0,01',
        range:  'm√©nƒõ ne≈æ 0,01√ó p≈ô√≠rodn√≠ho jasu',
        color:  '#000000',
        rgb:    [0, 0, 0],
        description: 'üåë P≈ôirozen√° tmav√° obloha'
    },
    {
        label:  '0,01 ‚Äì 0,02',
        range:  '0,01 ‚Äì 0,02√ó p≈ô√≠rodn√≠ho jasu',
        color:  '#282828',
        rgb:    [40, 40, 40],
        description: 'üåë T√©mƒõ≈ô p≈ôirozen√° obloha'
    },
    {
        label:  '0,02 ‚Äì 0,04',
        range:  '0,02 ‚Äì 0,04√ó p≈ô√≠rodn√≠ho jasu',
        color:  '#606060',
        rgb:    [96, 96, 96],
        description: 'üåí Velmi slab√© zneƒçi≈°tƒõn√≠'
    },
    {
        label:  '0,04 ‚Äì 0,08',
        range:  '0,04 ‚Äì 0,08√ó p≈ô√≠rodn√≠ho jasu',
        color:  '#1a3aaa',
        rgb:    [26, 58, 170],
        description: 'üîµ Slab√© zneƒçi≈°tƒõn√≠'
    },
    {
        label:  '0,08 ‚Äì 0,16',
        range:  '0,08 ‚Äì 0,16√ó p≈ô√≠rodn√≠ho jasu',
        color:  '#2255dd',
        rgb:    [34, 85, 221],
        description: 'üîµ M√≠rn√© zneƒçi≈°tƒõn√≠'
    },
    {
        label:  '0,16 ‚Äì 0,32',
        range:  '0,16 ‚Äì 0,32√ó p≈ô√≠rodn√≠ho jasu',
        color:  '#3377ff',
        rgb:    [51, 119, 255],
        description: 'üîµ Patrn√© zneƒçi≈°tƒõn√≠'
    },
    {
        label:  '0,32 ‚Äì 0,64',
        range:  '0,32 ‚Äì 0,64√ó p≈ô√≠rodn√≠ho jasu',
        color:  '#228833',
        rgb:    [34, 136, 51],
        description: 'üü¢ St≈ôedn√≠ zneƒçi≈°tƒõn√≠'
    },
    {
        label:  '0,64 ‚Äì 1,28',
        range:  '0,64 ‚Äì 1,28√ó p≈ô√≠rodn√≠ho jasu',
        color:  '#887744',
        rgb:    [136, 119, 68],
        description: 'üü§ V√Ωrazn√© zneƒçi≈°tƒõn√≠'
    },
    {
        label:  '1,28 ‚Äì 2,56',
        range:  '1,28 ‚Äì 2,56√ó p≈ô√≠rodn√≠ho jasu',
        color:  '#ccaa00',
        rgb:    [204, 170, 0],
        description: 'üü° Siln√© zneƒçi≈°tƒõn√≠'
    },
    {
        label:  '2,56 ‚Äì 5,12',
        range:  '2,56 ‚Äì 5,12√ó p≈ô√≠rodn√≠ho jasu',
        color:  '#ffdd00',
        rgb:    [255, 221, 0],
        description: 'üü° Velmi siln√© zneƒçi≈°tƒõn√≠'
    },
    {
        label:  '5,12 ‚Äì 10,2',
        range:  '5,12 ‚Äì 10,2√ó p≈ô√≠rodn√≠ho jasu',
        color:  '#ff4400',
        rgb:    [255, 68, 0],
        description: 'üî¥ Extr√©mn√≠ zneƒçi≈°tƒõn√≠'
    },
    {
        label:  '10,2 ‚Äì 20,5',
        range:  '10,2 ‚Äì 20,5√ó p≈ô√≠rodn√≠ho jasu',
        color:  '#ff00aa',
        rgb:    [255, 0, 170],
        description: 'üü£ Extr√©mn√≠ zneƒçi≈°tƒõn√≠'
    },
    {
        label:  '20,5 ‚Äì 41,0',
        range:  '20,5 ‚Äì 41,0√ó p≈ô√≠rodn√≠ho jasu',
        color:  '#ffaadd',
        rgb:    [255, 170, 221],
        description: '‚ö™ Maxim√°ln√≠ zneƒçi≈°tƒõn√≠'
    },
    {
        label:  '> 41,0',
        range:  'v√≠ce ne≈æ 41√ó p≈ô√≠rodn√≠ho jasu',
        color:  '#ffffff',
        rgb:    [255, 255, 255],
        description: '‚ö™ Maxim√°ln√≠ zneƒçi≈°tƒõn√≠ (centrum velkomƒõsta)'
    }
];

// ================================================================
// NAƒåTEN√ç PNG DO CANVASU (jednou p≈ôi startu)
// ================================================================
const canvas  = document.getElementById('pixel-canvas');
const ctx     = canvas.getContext('2d', { willReadFrequently: true });
let   imgLoaded = false;
let   imgObj    = new Image();

imgObj.crossOrigin = 'anonymous'; // nutn√© pro getImageData
imgObj.src = IMAGE_URL;

imgObj.onload = function () {
    canvas.width  = imgObj.naturalWidth;
    canvas.height = imgObj.naturalHeight;
    ctx.drawImage(imgObj, 0, 0);
    imgLoaded = true;
    console.log(`‚úÖ PNG naƒçteno: ${canvas.width}√ó${canvas.height}px`);
};

imgObj.onerror = function () {
    console.warn('‚ö†Ô∏è PNG se nepoda≈ôilo naƒç√≠st ‚Äî detekce barvy nebude fungovat.');
};

// ================================================================
// GPS sou≈ôadnice ‚Üí pixel v PNG
// ================================================================
function latlngToPixel(lat, lng) {
    const bounds = IMAGE_BOUNDS;
    const latMax = bounds[0][0]; // sever
    const latMin = bounds[1][0]; // jih
    const lngMin = bounds[0][1]; // z√°pad
    const lngMax = bounds[1][1]; // v√Ωchod

    const px = Math.round((lng - lngMin) / (lngMax - lngMin) * canvas.width);
    const py = Math.round((latMax - lat) / (latMax - latMin) * canvas.height);

    return { x: px, y: py };
}

// ================================================================
// P≈ôeƒçti RGB pixelu na dan√© GPS pozici
// ================================================================
function getPixelColor(lat, lng) {
    if (!imgLoaded) return null;

    const { x, y } = latlngToPixel(lat, lng);

    // Pr≈Ømƒõr z oblasti 5√ó5 px (robustnƒõj≈°√≠ ne≈æ jedin√Ω pixel)
    const size   = 5;
    const half   = Math.floor(size / 2);
    const x0     = Math.max(0, x - half);
    const y0     = Math.max(0, y - half);
    const w      = Math.min(size, canvas.width  - x0);
    const h      = Math.min(size, canvas.height - y0);

    const data   = ctx.getImageData(x0, y0, w, h).data;
    let r = 0, g = 0, b = 0, count = 0;

    for (let i = 0; i < data.length; i += 4) {
        // P≈ôeskoƒç pr≈Øhledn√© pixely (okraje obr√°zku)
        if (data[i + 3] < 128) continue;
        r += data[i];
        g += data[i + 1];
        b += data[i + 2];
        count++;
    }

    if (count === 0) return null;

    return {
        r: Math.round(r / count),
        g: Math.round(g / count),
        b: Math.round(b / count)
    };
}

// ================================================================
// Nejbli≈æ≈°√≠ kategorie k namƒõ≈ôen√© barvƒõ (nejmen≈°√≠ Euklidovsk√° vzd√°lenost)
// ================================================================
function matchCategory(rgb) {
    if (!rgb) return null;

    let bestCat  = null;
    let bestDist = Infinity;

    COLOR_CATEGORIES.forEach(function (cat) {
        const dr = rgb.r - cat.rgb[0];
        const dg = rgb.g - cat.rgb[1];
        const db = rgb.b - cat.rgb[2];
        // V√°hovan√° vzd√°lenost (lidsk√© oko citlivƒõj≈°√≠ na zelenou)
        const dist = Math.sqrt(dr*dr*0.3 + dg*dg*0.59 + db*db*0.11) * 255;
        if (dist < bestDist) {
            bestDist = dist;
            bestCat  = cat;
        }
    });

    return bestCat;
}

// ================================================================
// Hlavn√≠ funkce ‚Äî detekuj kategorii pro danou GPS pozici
// ================================================================
function detectPollutionCategory(lat, lng) {
    const rgb = getPixelColor(lat, lng);
    if (!rgb) return null;
    const cat = matchCategory(rgb);
    return { cat, rgb };
}

// ================================================================
// MAPA
// ================================================================
const map = L.map('map', {
    center: CZ_CENTER,
    zoom:   INITIAL_ZOOM,
    minZoom: 6,
    maxZoom: 18
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> p≈ôispƒõvatel√©',
    maxZoom: 19
}).addTo(map);

const lightPollutionOverlay = L.imageOverlay(IMAGE_URL, IMAGE_BOUNDS, {
    opacity: 0.70,
    interactive: false,
    className: 'light-pollution-overlay'
}).addTo(map);

const blendStyle = document.createElement('style');
blendStyle.textContent = `.light-pollution-overlay { mix-blend-mode: multiply; }`;
document.head.appendChild(blendStyle);

// Pr≈Øhlednost
const slider      = document.getElementById('opacity-slider');
const opacitySpan = document.getElementById('opacity-value');
slider.addEventListener('input', function () {
    lightPollutionOverlay.setOpacity(this.value / 100);
    opacitySpan.textContent = this.value + '%';
});

// ================================================================
// LEGENDA
// ================================================================
const legend = L.control({ position: 'bottomleft' });
legend.onAdd = function () {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
        <h4>Pomƒõr k p≈ô√≠rodn√≠mu jasu</h4>
        ${COLOR_CATEGORIES.map(cat => `
            <div class="legend-item">
                <div class="legend-color" style="background:${cat.color}"></div>
                ${cat.label}
            </div>
        `).join('')}
        <hr style="margin:8px 0; border-color:#444">
        <small style="color:#aaa; font-size:0.75em; line-height:1.4; display:block">
            ¬© ƒåesk√° astronomick√° spoleƒçnost, 2017<br>
            New World Atlas of Artificial Night Sky Brightness
        </small>
    `;
    return div;
};
legend.addTo(map);

// Tlaƒç√≠tko zpƒõt na ƒåR
const homeBtn = L.control({ position: 'topleft' });
homeBtn.onAdd = function () {
    const btn = L.DomUtil.create('button');
    btn.innerHTML = 'üá®üáø';
    btn.title = 'Zpƒõt na celou ƒåR';
    btn.style.cssText = `
        background:white; border:2px solid rgba(0,0,0,0.3);
        border-radius:4px; padding:5px 8px; font-size:1.2em;
        cursor:pointer; display:block; margin-top:5px;
    `;
    btn.onclick = () => map.setView(CZ_CENTER, INITIAL_ZOOM);
    L.DomEvent.disableClickPropagation(btn);
    return btn;
};
homeBtn.addTo(map);

// ================================================================
// VYHLED√ÅV√ÅN√ç
// ================================================================
const searchInput   = document.getElementById('search-input');
const searchBtn     = document.getElementById('search-btn');
const searchResults = document.getElementById('search-results');

let searchMarker  = null;
let searchTimeout = null;

document.addEventListener('click', function (e) {
    if (!document.getElementById('search-container').contains(e.target)) closeResults();
});

searchInput.addEventListener('keydown', function (e) {
    if (e.key === 'Enter')  doSearch(this.value.trim());
    if (e.key === 'Escape') closeResults();
});

searchInput.addEventListener('input', function () {
    clearTimeout(searchTimeout);
    const q = this.value.trim();
    if (q.length < 2) { closeResults(); return; }
    searchTimeout = setTimeout(() => doSearch(q), 500);
});

searchBtn.addEventListener('click', function () {
    const q = searchInput.value.trim();
    if (q) doSearch(q);
});

// ----- Vyhled√°n√≠ p≈ôes Nominatim -----
async function doSearch(query) {
    if (!query) return;
    searchBtn.disabled = true;
    showLoading();

    const url = `https://nominatim.openstreetmap.org/search`
        + `?q=${encodeURIComponent(query)}`
        + `&format=json`
        + `&addressdetails=1`
        + `&limit=6`
        + `&countrycodes=cz`
        + `&accept-language=cs`;

    try {
        const resp = await fetch(url, { headers: { 'Accept-Language': 'cs' } });
        if (!resp.ok) throw new Error('Chyba s√≠tƒõ');
        const data = await resp.json();
        searchBtn.disabled = false;
        renderResults(data);
    } catch (err) {
        searchBtn.disabled = false;
        showError('Nepoda≈ôilo se p≈ôipojit k vyhled√°vaƒçi.');
        console.error(err);
    }
}

// ----- Zobrazen√≠ v√Ωsledk≈Ø v dropdownu -----
function renderResults(data) {
    searchResults.innerHTML = '';
    searchResults.classList.add('visible');

    if (!data || data.length === 0) {
        searchResults.innerHTML = `<div class="search-no-result">üòï ≈Ω√°dn√° obec nenalezena.</div>`;
        return;
    }

    data.forEach(function (item) {
        const addr   = item.address || {};
        const name   = item.name || item.display_name.split(',')[0];
        const okres  = addr.county || '';
        const kraj   = addr.state  || '';
        const detail = [okres, kraj].filter(Boolean).join(', ');

        const lat = parseFloat(item.lat);
        const lng = parseFloat(item.lon);

        // Detekuj kategorii zneƒçi≈°tƒõn√≠
        const detection = detectPollutionCategory(lat, lng);
        let badgeHtml = '';

        if (detection && detection.cat) {
            const { cat, rgb } = detection;
            badgeHtml = `
                <div class="pollution-badge">
                    <div class="badge-dot" style="background:${cat.color}"></div>
                    <span>${cat.label} &nbsp;¬∑&nbsp; ${cat.description}</span>
                </div>
            `;
        } else if (!imgLoaded) {
            badgeHtml = `<div class="pollution-badge" style="color:#aaa">‚è≥ Naƒç√≠t√°m data...</div>`;
        }

        const div = document.createElement('div');
        div.className = 'search-result-item';
        div.innerHTML = `
            <div class="name">${escapeHtml(name)}</div>
            <div class="detail">${escapeHtml(detail || item.display_name)}</div>
            ${badgeHtml}
        `;

        div.addEventListener('click', function () {
            flyToResult(item, name, detail);
            closeResults();
            searchInput.value = name;
        });

        searchResults.appendChild(div);
    });
}

// ----- P≈ôelet na v√Ωsledek + marker s kategori√≠ -----
function flyToResult(item, name, detail) {
    const lat  = parseFloat(item.lat);
    const lng  = parseFloat(item.lon);
    const zoom = getZoomForType(item.type, item.class);

    if (searchMarker) { map.removeLayer(searchMarker); searchMarker = null; }

    map.flyTo([lat, lng], zoom, { duration: 1.4 });

    // Detekuj kategorii
    const detection = detectPollutionCategory(lat, lng);
    let pollutionHtml = '';

    if (detection && detection.cat) {
        const { cat, rgb } = detection;
        pollutionHtml = `
            <div class="popup-pollution-box" style="border-color:${cat.color}80">
                <div class="popup-pollution-dot" style="background:${cat.color}"></div>
                <div class="popup-pollution-text">
                    <strong>${cat.label}√ó p≈ô√≠rodn√≠ho jasu</strong>
                    <span>${cat.description}</span>
                </div>
            </div>
            <small style="color:#999; font-size:0.78em">
                Detekov√°no RGB: ${rgb.r}, ${rgb.g}, ${rgb.b}
            </small>
        `;
    }

    // Barva ≈°pendl√≠ku podle kategorie
    const pinColor = (detection && detection.cat) ? detection.cat.color : '#ffd700';
    const textColor = isLightColor(pinColor) ? '#000' : '#fff';

    const markerIcon = L.divIcon({
        className: '',
        html: `<div style="
            background: ${pinColor};
            border: 3px solid ${textColor === '#fff' ? '#333' : '#fff'};
            border-radius: 50% 50% 50% 0;
            width: 28px;
            height: 28px;
            transform: rotate(-45deg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        "></div>`,
        iconSize:    [28, 28],
        iconAnchor:  [14, 28],
        popupAnchor: [0, -32]
    });

    searchMarker = L.marker([lat, lng], { icon: markerIcon })
        .addTo(map)
        .bindPopup(`
            <div style="min-width:200px">
                <strong style="font-size:1.1em">${escapeHtml(name)}</strong><br>
                <span style="color:#666; font-size:0.9em">${escapeHtml(detail)}</span><br>
                <small style="color:#999">${lat.toFixed(5)}, ${lng.toFixed(5)}</small>
                ${pollutionHtml}
            </div>
        `, { maxWidth: 280 })
        .openPopup();
}

// ----------------------------------------------------------------
// Pomocn√© funkce
// ----------------------------------------------------------------
function getZoomForType(type, cls) {
    if (type === 'city')           return 13;
    if (type === 'town')           return 14;
    if (type === 'village')        return 14;
    if (type === 'hamlet')         return 15;
    if (type === 'suburb')         return 15;
    if (type === 'administrative') return 11;
    if (cls  === 'boundary')       return 10;
    return 13;
}

// Je barva svƒõtl√°? (pro kontrast textu)
function isLightColor(hex) {
    const c   = hex.replace('#', '');
    const r   = parseInt(c.substr(0,2), 16);
    const g   = parseInt(c.substr(2,2), 16);
    const b   = parseInt(c.substr(4,2), 16);
    const lum = (0.299*r + 0.587*g + 0.114*b);
    return lum > 150;
}

function showLoading() {
    searchResults.innerHTML = `<div class="search-loading" style="padding:14px;text-align:center;color:#ffd700">‚è≥ Hled√°m...</div>`;
    searchResults.classList.add('visible');
}

function showError(msg) {
    searchResults.innerHTML = `<div style="padding:14px;text-align:center;color:#ff6666">${msg}</div>`;
    searchResults.classList.add('visible');
}

function closeResults() {
    searchResults.classList.remove('visible');
    searchResults.innerHTML = '';
}

function escapeHtml(str) {
    if (!str) return '';
    return str
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}
</script>
</body>
</html>